# 知识图谱服务设计文档

## 1. 概述

### 1.1 目的

为 ChipForge-AI 提供知识图谱服务，支持 FPGA 电路设计的信号、状态等信息的结构化存储和查询。

### 1.2 核心价值

- **持久化**：跨会话保存设计信息
- **结构化**：以图结构存储信号关系
- **可查询**：支持 BFS 深度查询关联信息

### 1.3 技术选型

| 组件 | 选择 | 理由 |
|------|------|------|
| 图结构 | NetworkX | 轻量级、Python 生态成熟 |
| 存储 | JSON | 简单、易版本控制 |
| 集成 | MCP Tool | 与 Claude Code 无缝集成 |

---

## 2. 架构设计

### 2.1 分层架构

```
┌─────────────────┐
│   Claude Code   │  ← 执行者
└────────┬────────┘
         │
┌────────▼────────┐
│     Skill       │  ← 定义流程、判断关系
└────────┬────────┘
         │ 调用 MCP Tool
┌────────▼────────┐
│  MCP Server     │  ← CRUD 实现
│  (知识图谱服务)  │
└─────────────────┘
```

### 2.2 职责划分

| 层级 | 职责 |
|------|------|
| Skill/LLM | 分析需求、提取信号、判断节点间关系 |
| 知识图谱服务 | 只负责 CRUD，不做业务判断 |

### 2.3 存储位置

```
project/
└── .chipforge/
    └── kg/
        └── graph.json
```

---

## 3. 数据模型

### 3.1 节点类型

| 类型 | 说明 | 示例 |
|------|------|------|
| Signal | 电路信号 | clk, rst, data_in |
| StateTransition | 状态转换 | IDLE → RUNNING |
| SignalExample | 信号示例 | 时序波形描述 |

### 3.2 关系类型

| 关系 | 说明 |
|------|------|
| EXAMPLES | Signal 的示例 |
| STATETRANSITION | 信号参与状态转换 |
| RELATED | 信号间关联 |

### 3.3 节点结构

```json
{
  "id": "clk",
  "type": "Signal",
  "properties": {
    "description": "时钟信号",
    "width": "1",
    "direction": "input"
  }
}
```

### 3.4 关系结构

```json
{
  "from": "clk",
  "to": "clk_example",
  "type": "EXAMPLES"
}
```

### 3.5 存储格式

```json
{
  "graphId": "default",
  "nodes": [...],
  "relations": [...]
}
```

---

## 4. 接口设计

### 4.1 接口列表

| 接口 | 用途 |
|------|------|
| kg_init | 批量初始化 |
| kg_create_node | 创建节点 |
| kg_create_relation | 创建关系 |
| kg_delete_node | 删除节点 |
| kg_delete_relation | 删除关系 |
| kg_update_node | 更新节点 |
| kg_query | BFS 查询 |
| kg_list | 列出节点 |

### 4.2 接口详情

#### kg_init

批量初始化图谱，如已存在则覆盖。

```java
@Tool("kg_init")
void init(String graphId, String nodes, String relations);
```

#### kg_create_node

创建单个节点，ID 已存在则报错。

```java
@Tool("kg_create_node")
void createNode(String graphId, String id, String type, String properties);
```

#### kg_create_relation

创建关系，节点不存在或关系已存在则报错。

```java
@Tool("kg_create_relation")
void createRelation(String graphId, String fromId, String toId, String type);
```

#### kg_delete_node

删除节点，有关联关系则报错。

```java
@Tool("kg_delete_node")
void deleteNode(String graphId, String id);
```

#### kg_delete_relation

删除关系，不存在则报错。

```java
@Tool("kg_delete_relation")
void deleteRelation(String graphId, String fromId, String toId, String type);
```

#### kg_update_node

更新节点属性（全量替换）。

```java
@Tool("kg_update_node")
void updateNode(String graphId, String id, String properties);
```

#### kg_query

BFS 查询关联节点。

```java
@Tool("kg_query")
String query(String graphId, String nodeId, int depth);
```

#### kg_list

列出节点（可按类型过滤）。

```java
@Tool("kg_list")
String list(String graphId, String type);
```

---

## 5. 规范

### 5.1 节点 ID 规范

| 规则 | 说明 |
|------|------|
| 长度 | ≤ 60 字符 |
| 允许字符 | 字母、数字、下划线、连字符 |
| 开头 | 不能以数字开头 |
| 大小写 | 敏感 |

**正则**：`^[a-zA-Z_][a-zA-Z0-9_-]{0,59}$`

### 5.2 属性规范

采用自由 key-value 结构，常用属性参考：

| 节点类型 | 常用属性 |
|---------|---------|
| Signal | description, width, direction |
| StateTransition | description, from, to, condition |
| SignalExample | description, timing |

---

## 6. 错误处理

### 6.1 返回格式

```json
// 成功
{"success": true, "data": ...}

// 失败
{"success": false, "error": "错误描述", "code": "ERROR_CODE"}
```

### 6.2 错误码

| 错误码 | 说明 |
|--------|------|
| NODE_EXISTS | 节点已存在 |
| NODE_NOT_FOUND | 节点不存在 |
| RELATION_EXISTS | 关系已存在 |
| RELATION_NOT_FOUND | 关系不存在 |
| HAS_RELATIONS | 节点有关联关系 |
| INVALID_ID | ID 格式无效 |
| INVALID_TYPE | 类型无效 |

### 6.3 各接口错误

| 接口 | 可能的错误 |
|------|-----------|
| kg_init | 无 |
| kg_create_node | NODE_EXISTS, INVALID_ID, INVALID_TYPE |
| kg_create_relation | NODE_NOT_FOUND, RELATION_EXISTS |
| kg_delete_node | NODE_NOT_FOUND, HAS_RELATIONS |
| kg_delete_relation | RELATION_NOT_FOUND |
| kg_update_node | NODE_NOT_FOUND |
| kg_query | NODE_NOT_FOUND |
| kg_list | 无 |
