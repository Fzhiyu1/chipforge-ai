# 探索文档：知识图谱功能

## 探索目标

设计 ChipForge-AI 的知识图谱功能，为 FPGA 开发提供设计辅助支持。

## 背景

参考 VerilogCoder 项目的知识图谱实现，设计适合 ChipForge-AI 的知识图谱服务。知识图谱用于帮助 AI 理解和规划电路设计，支持跨会话持久化。

## 待探索内容

- [x] VerilogCoder 技术分析
- [x] 知识图谱定位
- [x] 实现方式选型
- [x] CRUD 接口设计
- [x] 数据结构设计
- [x] 节点 ID 策略
- [x] 错误处理设计

---

## 探索记录

### 话题1：VerilogCoder 技术分析

**技术栈**：

| 技术 | 用途 |
|------|------|
| NetworkX | 图数据结构（DiGraph 有向图） |
| LangChain | LLM 集成框架 |
| Pydantic | 数据模型定义 |
| OpenAI/LLM | 生成节点ID、确定关系 |

**节点类型**：Plan、Signal、StateTransition、SignalExample

**关系类型**：IMPLEMENTS、EXAMPLES、STATETRANSITION、NORELATION

**关键特点**：
- LLM 驱动 - 节点ID和关系由 LLM 生成
- 轻量存储 - 使用 JSON 文件
- BFS 查询 - 支持多层级邻居检索
- 动态构建 - 根据输入动态生成图谱

---

### 话题2：知识图谱定位

**错误理解**：知识图谱 = 通用知识库（查语法、设计模式）

**正确理解**：知识图谱 = 设计辅助工具

**核心价值**：
1. **持久化** - 跨会话保存设计信息
2. **可视化** - 展示信号关系图
3. **一致性检查** - 验证设计是否自洽

**与 Claude Code 的关系**：

| 能力 | Claude Code | 知识图谱 |
|------|-------------|----------|
| 单次对话 | ✅ 足够 | 不需要 |
| 跨会话记忆 | ❌ 丢失 | ✅ 持久化 |
| 复杂电路设计 | ⚠️ 上下文有限 | ✅ 结构化存储 |

---

### 话题3：实现方式选型

**方案对比**：

| 方面 | Skill 脚本 | MCP Server |
|------|-----------|------------|
| 定位 | 流程定义/提示词 | 独立服务 |
| 状态管理 | 困难（无状态） | 容易（可常驻内存） |
| 持久化 | 需要每次读写文件 | 可缓存 + 定期持久化 |
| 部署 | 无需额外启动 | 需要启动服务 |
| 复用性 | 仅 Claude Code | 任何 MCP 客户端 |

**结论**：采用 **MCP Server + Skill** 混合方案

**架构**：
```
┌─────────────────┐
│   Claude Code   │  ← 执行者
└────────┬────────┘
         │
┌────────▼────────┐
│     Skill       │  ← 定义流程
└────────┬────────┘
         │ 调用 MCP Tool
┌────────▼────────┐
│  MCP Server     │  ← CRUD 实现
│  (知识图谱服务)  │
└─────────────────┘
```

---

### 话题4：CRUD 接口设计

**分层职责**：
- **Skill/LLM 层**：分析需求、提取信号、判断关系
- **知识图谱服务**：只负责 CRUD，不做业务判断

**接口列表**：

| 接口 | 用途 |
|------|------|
| `kg_init` | 批量初始化（节点+关系） |
| `kg_create_node` | 增量添加单个节点 |
| `kg_create_relation` | 增量添加关系 |
| `kg_delete_node` | 删除节点 |
| `kg_delete_relation` | 删除关系 |
| `kg_update_node` | 更新节点 |
| `kg_query` | BFS 查询 |
| `kg_list` | 列出节点 |

**kg_query vs kg_list**：
- `kg_list`：列出所有节点（不含关系）
- `kg_query`：从某节点出发的关联节点（通过关系连接）

---

### 话题5：接口参数设计

**存储位置**：`project/.chipforge/kg/graph.json`

**接口详情**：

```java
// 批量初始化（覆盖模式）
kg_init(graphId, nodes, relations)

// 创建节点（ID已存在则报错）
kg_create_node(graphId, id, type, properties)

// 创建关系（节点不存在或关系已存在则报错）
kg_create_relation(graphId, fromId, toId, type)

// 删除节点（有关联关系则报错）
kg_delete_node(graphId, id)

// 删除关系
kg_delete_relation(graphId, fromId, toId, type)

// 更新节点（全量替换属性）
kg_update_node(graphId, id, properties)

// BFS 查询
kg_query(graphId, nodeId, depth)

// 列出节点
kg_list(graphId, type)
```

---

### 话题6：数据结构设计

**节点结构**：
```json
{
  "id": "clk",
  "type": "Signal",
  "properties": {"description": "时钟信号", "width": "1"}
}
```

**关系结构**：
```json
{"from": "clk", "to": "clk_example", "type": "EXAMPLES"}
```

**属性设计**：采用自由 key-value 结构（不强制字段）

**常用属性参考**：

| 节点类型 | 常用属性 |
|---------|---------|
| Signal | description, width, direction |
| StateTransition | description, from, to, condition |
| SignalExample | description, timing |

---

### 话题7：节点 ID 策略

**VerilogCoder 做法**：LLM 生成，人类可读，≤60 字符

**我们的设计**：由 Skill/智能体指定，知识图谱不生成

**ID 规范**：
- 长度 ≤ 60 字符
- 允许字符：字母、数字、下划线、连字符
- 不能以数字开头
- 大小写敏感

**正则**：`^[a-zA-Z_][a-zA-Z0-9_-]{0,59}$`

---

### 话题8：错误处理设计

**返回格式**：
```json
// 成功
{"success": true, "data": ...}

// 失败
{"success": false, "error": "错误描述", "code": "ERROR_CODE"}
```

**错误码**：

| 错误码 | 说明 |
|--------|------|
| NODE_EXISTS | 节点已存在 |
| NODE_NOT_FOUND | 节点不存在 |
| RELATION_EXISTS | 关系已存在 |
| RELATION_NOT_FOUND | 关系不存在 |
| HAS_RELATIONS | 节点有关联关系 |
| INVALID_ID | ID 格式无效 |
| INVALID_TYPE | 类型无效 |

---

## 结论

### 技术选型

| 组件 | 选择 |
|------|------|
| 图结构 | NetworkX |
| 存储 | JSON |
| 集成 | MCP Tool |

### 下一步

1. 实现 MCP Server CRUD 接口
2. 实现持久化存储
3. 设计 Skill 流程
4. 集成测试
